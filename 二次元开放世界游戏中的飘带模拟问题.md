
# 简介
开放世界二次元游戏中，角色的布料和头发(下文统称为飘带)模拟问题一直是所有厂商都头痛的一大难题。
其难点有：
1. 飘带设计的复杂性。目前的开放世界二游，以卖角色为主要盈利方式。为了角色美观，通常角色的衣服都很复杂，多层衣物，小挂件，甚至不规则衣物。都给使用实时模拟的方法带来了极大的挑战。
2. 二次元游戏飘带表现的特殊性。通常二次元游戏的飘带不要求飘带能够和现实的表现布料完全一样，反而是需要一些风格化的表现，通常二次元游戏的角色的动作会有更大幅度的摆动（Idle时，二次元游戏动作幅度就比写实游戏的大得多），而飘带也需要作出强摆动效果。也就是说 UE的Chaos, Havok的HavokCloth等通常用于写实游戏的布料结算思路一般不太行得通。
3. 近些年的二次元开放世界游戏，通常都需要多端运行，为了能兼容移动端，Chaos/HavokCloth等方法会有更大的性能压力。
4. 开放世界游戏需要处理的角色动画情况最为复杂，飘带穿插风险最大。

# 已知的做法
想要探究标题的问题，最好还是先看看别人怎么做的。那么现有的游戏是如何做的呢？
限于本人游玩过的开放世界卡通向游戏就这么几个。也就只分析这几个！
## 塞尔达传说
根据我观察，塞尔达传说大概率使用的是HavokCloth。塞尔达的动画现整体偏向于写实，角色并没有那种大幅度摇晃的二次元角色效果。

## O神
原神的飘带动画，是在离线制作飘带动画的基础上，通过实时模拟在飘带末端添加小幅度惯性摆动和碰撞。
这个做法很自然也很聪明，通过离线制作飘带动画打底子，再辅助轻微的模拟。解决了大部分飘带的动画问题。
这样的做法，需要实时模拟解决的问题主要有两个：
 - "不合法"动画过度的飘带适配
 原神并没有解决这个问题。因为原神的飘带离线部分的权重非常大，实时模拟的部分权重很小。起步后立即停步这种“不合法”的运动的时候可以看到飘带还是有不自然的摆动。
 - 程序动画飘带适配
 程序动画主要是IK。当脚步IK，攀爬的手臂IK修改了四肢时，靠近四肢的飘带极易穿插，LookAtIK时，如果不添加碰撞，头发一般会直接插到身体里。原神在这方面还是做了一些努力的。不过表现也并不完美。物理模拟中常见的抖动、穿模还是很容易出现的。脚步IK抬腿的时候，腿前稍微长一些的飘带就穿到肉里面去了。


## 鸣潮
鸣潮和原神的思路基本一致。只是鸣潮这边处理这两个问题的时候似乎得到的结果不如原神那么好。
我分析了一下，大概是鸣潮飘带设计的更复杂，比如今夕的新皮肤飘带就很吓人。还有就是鸣潮使用了KawaiiPhysics，或许这个插件的上限也不太够吧（不太清楚库洛游戏的程序有没有定制修改过）。

## 无限暖暖
根据叠纸游戏的 OpenProblem CloseSolution的UE开放日报告(https://www.bilibili.com/video/BV1WJ2LYuE8C)。我们知道无限暖暖采用了自研的NikkiPhysics来实时模拟飘带。我自己解包游戏的时候也没有发现3c资产中有飘带动画的痕迹，仅有少数特殊动画是离线制作的飘带动画。
早在19年，叠纸在unity其实已经实现了这一套飘带模拟算法(https://www.bilibili.com/video/BV1hJ411W7Yd)。基本的内容点在行业内也不算什么机密，但是，叠纸能把一个个小点整合起来，并且模拟效果做的稳定并落地到上线项目。
题外话：这里批评一下叠纸这个技术分享，分享了个寂寞，只提问题不说答案。诗人我吃？Unreal Open Day你是啥也没Open，要是机密不能说出来，那就别说。引用评论区一句话"说问题但是不说解决方案就好比发图不留种"。

根据我自己对飘带模拟的认知，浅浅推测一下叠纸游戏提到的飘带实时模拟的一些问题如何解决吧：
1. 飘带和身体的碰撞
叠纸在Unity的分享中提到了一嘴。身体使用锥形胶囊体建模，飘带使用了通过骨骼和顶点计算出来的一个虚拟碰撞体建模。
2. 飘带和飘带的碰撞
    - 首先需要对飘带划分部位。确定在这一次碰撞检测中，“固定”的飘带部位，然后让运动的飘带做一次碰撞检测即可。相当于把飘带和飘带的碰撞问题简化为飘带和身体的碰撞问题。
    - 对飘带划分部位，涵盖了一个隐性要求，那就是需要飘带能够层次分明，例如一个原本建模时就来回交织的两条飘带，是无法做这件事的。因此还对飘带的设计有一定的要求。
3. 飘带和场景的碰撞
飘带通过发射射线等场景场景查询手段，去检查飘带的碰撞体是否有和场景发生穿插。


虽然思路不复杂，想要实现好还是挺困难的。
首先飘带的碰撞体建模这一步就比较麻烦。一般情况下会使用最简单的形状<球形>作为飘带模拟中质点的碰撞体形状。听叠纸的意思似乎并不是使用球形。大概率是一个或多个其他简单形状吧。毕竟碰撞检测的形状越复杂性能可扛不住。
其次是锥形胶囊体的碰撞检测也是一个麻烦事，一般的物理引擎会采用GJK+EPA来计算凸体是否穿插，以及其穿插方向和距离。但是我实际测试过这玩意消耗有点恐怖，应该是达不到性能要求的。我想到的一个近似方案是线段求最近点，不过由于是锥形胶囊体，会有可能出现错误的情况。
最后则是对绑定的要求，为了能让碰撞效果更好，骨骼绑定的不能太糙，骨骼间距过大是很难得到一个较好的模拟效果和碰撞效果的。

# 总结
对于开放世界二游来说，采用类原神的，以离线飘带为主，实时飘带为辅的制作方式，可以保证飘带动画品质的下限。
也就是说，二游所需的飘带复杂性，飘带动画风格化，性能都能较好的兼顾。
而通常情况下，实时模拟飘带主要在以下情况发力：
1. IK修改了身体骨骼动画时
2. 风场等场景中的游戏元素与飘带交互时
3. "不合法"的动画过渡时

看似只需要在以上情况开启模拟即可得到很好的飘带表现。但实则以上三条，现今的开放世界二游，都没有处理的很好。因为其处理难度基本与实时模拟相当。即使是无限暖暖，也限制了开放世界探索的玩法，Locomotion仅仅保留了地面移动和空中飞行两大类。二游特色的攀爬，游泳，炫酷的战斗动画，翻滚/闪避，等等都被丢弃了。不知道是否也包含了实时飘带的部分原因在内呢？

针对以上问题，在参考无限暖暖飘带模拟的基础上，自制了一份UnrealEngine的飘带模拟插件:
目前分享在：https://github.com/LoogLong/UnrealPlugin



